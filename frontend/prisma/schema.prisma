// ∞8 ARCH - Declarations v1.0
// Creative provenance protocol for AI-native music

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Declaration: The unified track registration
// Combines CTAD metadata + SOVN consent + ∞8 ARCH scoring
model Declaration {
  id                String   @id @default(cuid())

  // Blockchain references
  contractId        String?  // Contract address
  tokenId           Int?     // NFT token ID
  txHash            String?  // Mint transaction hash

  // Track metadata (CTAD layer)
  title             String   @default("")
  artistName        String
  artistWallet      String?
  authMethod        String   @default("anonymous")

  // AI contribution scores (0-100) — 5 phases
  aiComposition     Int      @default(0)
  aiArrangement     Int      @default(0)
  aiProduction      Int      @default(0)
  aiMixing          Int      @default(0)
  aiMastering       Int      @default(0)

  // Computed scores
  transparencyScore Int      @default(0)

  // Methodology description (public - describes process)
  methodology       String?

  // AI Prompt (optional - exact prompt, artist controls visibility)
  aiPrompt          String?
  promptVisibility  String   @default("private") // "public", "private", "paywalled"

  // Creative Stack (tools used in production)
  daws              String?  // DAWs used (comma-separated)
  plugins           String?  // Plugins used (comma-separated)
  aiModels          String?  // AI models used (comma-separated)
  hardware          String?  // Hardware used (comma-separated)

  // Lineage
  parentDeclarationId String?
  parentRelation      String?

  // Contributor splits (JSON array)
  contributorSplits Json     @default("[]")

  // IPFS + verification
  ipfsCID           String   @default("")
  sha256            String   @default("")

  // SOVN consent toggles
  trainingRights    Boolean  @default(false)
  derivativeRights  Boolean  @default(false)
  remixRights       Boolean  @default(false)
  consentLocked     Boolean  @default(false)
  splitsLocked      Boolean  @default(false)

  // Badge earned
  badge             String?  // "HUMAN_CRAFTED", "AI_DISCLOSED", "SOVEREIGN", etc.

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  mintedAt          DateTime?

  // Indexes for common queries
  @@index([artistWallet])
  @@index([artistName])
  @@index([tokenId])
  @@index([transparencyScore])
  @@index([badge])
}

// LicenseRequest: Track licensing requests (SOVN enforcement)
model LicenseRequest {
  id              String   @id @default(cuid())
  declarationId   String
  requesterWallet String
  requesterName   String?
  permissionType  String   // "training", "derivative", "remix"
  status          String   @default("pending") // "pending", "approved", "denied"

  // Optional payment info
  paymentTxHash   String?
  paymentAmount   String?  // In ∞8 tokens

  createdAt       DateTime @default(now())
  respondedAt     DateTime?

  @@index([declarationId])
  @@index([requesterWallet])
  @@index([status])
}

// RewardHistory: Track ∞8 token rewards
model RewardHistory {
  id              String   @id @default(cuid())
  declarationId   String
  artistWallet    String
  rewardType      String   // "human_crafted", "transparent", "consent_locked", "early_adopter"
  amount          String   // Token amount in wei
  txHash          String?

  createdAt       DateTime @default(now())

  @@index([artistWallet])
  @@index([declarationId])
}

// CreatorIdentity: Unified identity for voice/audio/visual DNA (v2.0 protocol)
// Used by Vòxā for voice provenance registration
model CreatorIdentity {
  id                  String   @id @default(cuid())
  identityId          String   @unique // Format: "o8-[hash]"
  version             String   @default("2.0")

  // Creator info
  creatorName         String
  creatorWallet       String?
  creatorSignature    String?
  verificationLevel   String   @default("none") // "none", "basic", "enhanced", "verified"

  // Voice DNA (from Vòxā/Chromox) - stored as JSON
  voiceDNA            Json?

  // Audio DNA (from Starforge) - stored as JSON
  audioDNA            Json?

  // Visual DNA (from Clarosa) - stored as JSON
  visualDNA           Json?

  // Narrative DNA (from Boveda) - stored as JSON
  narrativeDNA        Json?

  // Character Genome (from Boveda) - stored as JSON
  genome              Json?

  // Licensing terms
  trainingRights      Boolean  @default(false)
  derivativeRights    Boolean  @default(true)
  commercialRights    Boolean  @default(true)
  attributionRequired Boolean  @default(true)
  revenueSplit        Float    @default(0.4) // 0-1, e.g., 0.4 = 40%
  ratePerSecondCents  Int?     // Optional fixed rate per synthesis second

  // Provenance
  audioFingerprint    String?  // SHA-256 of reference audio
  audioDurationMs     Int?
  audioFormat         String?
  ipfsCid             String?
  blockchainTx        String?

  // Provider references
  chromoxPersonaId    String?  // Links to Vòxā persona
  bovedaGenomeId      String?  // Links to Boveda genome
  starforgeCatalogId  String?  // Links to Starforge catalog

  // Coherence metrics (computed)
  coherenceOverall    Float?
  coherencePairwise   Json?

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([creatorWallet])
  @@index([creatorName])
  @@index([chromoxPersonaId])
  @@index([verificationLevel])
}
